<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชูุงุตูู ุงูุฅุนูุงู - ุณููุนุฉ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- ุงูููุฏุฑ -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo">ุณููุนุฉ</a>
                <ul class="nav-links">
                    <li><a href="index.html">ุงูุฑุฆูุณูุฉ</a></li>
                    <li><a href="dashboard.html">ููุญุฉ ุงูุชุญูู</a></li>
                    <li><a href="messages.html">ุงูุฑุณุงุฆู</a></li>
                </ul>
                <div class="auth-buttons">
                    <!-- ุณูุชู ุชุญุฏูุซ ูุฐุง ุงููุณู ุจูุงุณุทุฉ JavaScript -->
                </div>
            </nav>
        </div>
    </header>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <main class="main-content">
        <div class="container">
            <div id="adDetailsContainer">
                <!-- ุณูุชู ุชุญููู ุชูุงุตูู ุงูุฅุนูุงู ููุง -->
            </div>
        </div>
    </main>

    <!-- ุงูููุชุฑ -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 ููุตุฉ ุณููุนุฉ. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
        </div>
    </footer>

    <script src="js/script.js"></script>
    <script>
        let currentAd = null;

        // ุชุญููู ุชูุงุตูู ุงูุฅุนูุงู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const adId = urlParams.get('id');
            
            if (!adId) {
                showAlert('ูุนุฑู ุงูุฅุนูุงู ุบูุฑ ุตุญูุญ', 'danger');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            loadAdDetails(adId);
        });

        // ุชุญููู ุชูุงุตูู ุงูุฅุนูุงู
        async function loadAdDetails(adId) {
            try {
                showLoading();
                const response = await apiCall(`ads.php?action=get&ad_id=${adId}`, 'GET');
                hideLoading();
                
                if (response.success) {
                    currentAd = response.data;
                    updateAdDetailsUI();
                } else {
                    showAlert('ุงูุฅุนูุงู ุบูุฑ ููุฌูุฏ', 'danger');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            } catch (error) {
                hideLoading();
                showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุชูุงุตูู ุงูุฅุนูุงู', 'danger');
                console.error('Load ad details error:', error);
            }
        }

        // ุชุญุฏูุซ ูุงุฌูุฉ ุชูุงุตูู ุงูุฅุนูุงู
        function updateAdDetailsUI() {
            const container = document.getElementById('adDetailsContainer');
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h1 class="card-title">${currentAd.title}</h1>
                                
                                <div class="ad-image mb-4">
                                    ${currentAd.image_url ? 
                                        `<img src="${currentAd.image_url}" alt="${currentAd.title}" style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 10px;">` : 
                                        '<div style="width: 100%; height: 300px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center; border-radius: 10px; color: #6c757d;">ูุง ุชูุฌุฏ ุตูุฑุฉ</div>'
                                    }
                                </div>
                                
                                <div class="ad-meta mb-4">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>ุงูุณุนุฑ:</strong> <span class="text-success" style="font-size: 1.5rem;">${currentAd.price} โช</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>ุงููููุน:</strong> ๐ ${currentAd.location}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>ุงููุฆุฉ:</strong> ${currentAd.category_name}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>ุชุงุฑูุฎ ุงููุดุฑ:</strong> ${formatDate(currentAd.created_at)}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="ad-description">
                                    <h3>ุงููุตู</h3>
                                    <p>${currentAd.description}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h3 class="card-title">ูุนูููุงุช ุงูุจุงุฆุน</h3>
                                <p><strong>ุงูุงุณู:</strong> ${currentAd.username}</p>
                                <p><strong>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:</strong> ${currentAd.email}</p>
                                
                                ${currentUser && currentUser.user_id !== currentAd.user_id ? `
                                    <button onclick="showContactModal()" class="btn btn-success w-100 mb-3">ุชูุงุตู ูุน ุงูุจุงุฆุน</button>
                                ` : ''}
                                
                                ${currentUser && currentUser.user_id === currentAd.user_id ? `
                                    <div class="alert alert-info">
                                        ูุฐุง ุฅุนูุงูู
                                    </div>
                                    <button onclick="editAd()" class="btn btn-primary w-100 mb-2">ุชุนุฏูู ุงูุฅุนูุงู</button>
                                    <button onclick="deleteAd()" class="btn btn-danger w-100">ุญุฐู ุงูุฅุนูุงู</button>
                                ` : ''}
                                
                                ${!currentUser ? `
                                    <div class="alert alert-info">
                                        <a href="login.html">ุณุฌู ุฏุฎููู</a> ููุชูุงุตู ูุน ุงูุจุงุฆุน
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-body">
                                <h4 class="card-title">ูุตุงุฆุญ ููุฃูุงู</h4>
                                <ul style="font-size: 0.9rem;">
                                    <li>ุชุฃูุฏ ูู ุงูููุชุฌ ูุจู ุงูุฏูุน</li>
                                    <li>ุงูุชูู ูู ููุงู ุนุงู ูุขูู</li>
                                    <li>ูุง ุชุดุงุฑู ูุนูููุงุชู ุงููุงููุฉ</li>
                                    <li>ุชุฃูุฏ ูู ูููุฉ ุงูุจุงุฆุน</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ุนุฑุถ ูุงูุฐุฉ ุงูุชูุงุตู
        function showContactModal() {
            if (!currentUser) {
                showAlert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู', 'danger');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>ุชูุงุตู ูุน ุงูุจุงุฆุน</h3>
                        <button onclick="closeModal()" class="btn btn-secondary">ร</button>
                    </div>
                    <div class="modal-body">
                        <p><strong>ุงูุฅุนูุงู:</strong> ${currentAd.title}</p>
                        <p><strong>ุงูุจุงุฆุน:</strong> ${currentAd.username}</p>
                        <hr>
                        <form id="contactForm">
                            <input type="hidden" name="receiver_id" value="${currentAd.user_id}">
                            <input type="hidden" name="ad_id" value="${currentAd.ad_id}">
                            <div class="form-group">
                                <label class="form-label">ุฑุณุงูุชู</label>
                                <textarea name="message_content" class="form-control" rows="4" placeholder="ูุฑุญุจุงูุ ุฃูุง ููุชู ุจูุฐุง ุงูุฅุนูุงู..." required></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">ุฅุฑุณุงู ุงูุฑุณุงูุฉ</button>
                                <button type="button" onclick="closeModal()" class="btn btn-secondary">ุฅูุบุงุก</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ุฑุจุท ุญุฏุซ ุงููููุฐุฌ
            document.getElementById('contactForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const messageData = {
                    sender_id: currentUser.user_id,
                    receiver_id: formData.get('receiver_id'),
                    ad_id: formData.get('ad_id'),
                    message_content: formData.get('message_content')
                };
                
                try {
                    const response = await apiCall('messages.php?action=send', 'POST', messageData);
                    
                    if (response.success) {
                        showAlert('ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจูุฌุงุญ', 'success');
                        closeModal();
                    } else {
                        showAlert(response.message, 'danger');
                    }
                } catch (error) {
                    showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุฑุณุงูุฉ', 'danger');
                    console.error('Send message error:', error);
                }
            });
        }

        // ุชุนุฏูู ุงูุฅุนูุงู
        function editAd() {
            showAlert('ูุธููุฉ ุงูุชุนุฏูู ููุฏ ุงูุชุทููุฑ', 'info');
        }

        // ุญุฐู ุงูุฅุนูุงู
        async function deleteAd() {
            if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุฅุนูุงูุ')) {
                return;
            }

            try {
                const response = await apiCall('ads.php?action=delete', 'POST', {
                    ad_id: currentAd.ad_id,
                    user_id: currentUser.user_id
                });

                if (response.success) {
                    showAlert('ุชู ุญุฐู ุงูุฅุนูุงู ุจูุฌุงุญ', 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    showAlert(response.message, 'danger');
                }
            } catch (error) {
                showAlert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุฅุนูุงู', 'danger');
                console.error('Delete ad error:', error);
            }
        }
    </script>
</body>
</html>

